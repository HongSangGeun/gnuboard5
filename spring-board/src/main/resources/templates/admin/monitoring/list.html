<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/layout}">

<head>
    <title>ì™¸ë¶€ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§</title>
</head>

<body>
<div layout:fragment="content">
    <div class="local_desc01 local_desc">
        <p>ì™¸ë¶€ ì„œë¹„ìŠ¤ì˜ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="local_ov01 local_ov">
        <a th:href="@{/mgmt/monitoring/create}" class="btn btn_01">ì„œë¹„ìŠ¤ ë“±ë¡</a>
    </div>

    <div class="tbl_head01 tbl_wrap">
        <table>
            <caption>ì™¸ë¶€ ì„œë¹„ìŠ¤ ëª©ë¡</caption>
            <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">ì„œë¹„ìŠ¤ëª…</th>
                <th scope="col">URL</th>
                <th scope="col">ìƒíƒœ</th>
                <th scope="col">ì²´í¬ì£¼ê¸°</th>
                <th scope="col">í™œì„±í™”</th>
                <th scope="col">ì•Œë¦¼</th>
                <th scope="col">ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="service : ${services}">
                <td th:text="${service.msId}">1</td>
                <td>
                    <strong th:text="${service.msName}">ì„œë¹„ìŠ¤ëª…</strong>
                    <div th:if="${service.msDescription}" style="font-size:12px;color:#777;margin-top:4px;"
                         th:text="${service.msDescription}">ì„¤ëª…</div>
                </td>
                <td>
                    <div style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                         th:text="${service.msUrl}" th:title="${service.msUrl}">URL</div>
                    <div style="font-size:11px;color:#999;margin-top:2px;">
                        <span th:text="${service.msMethod}">GET</span>
                        <span th:if="${service.msAuthType != null and service.msAuthType != 'NONE'}">
                            | ğŸ”’ <span th:text="${service.msAuthType}">AUTH</span>
                        </span>
                        | íƒ€ì„ì•„ì›ƒ: <span th:text="${service.msTimeout}">5000</span>ms
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn_02 check-service"
                            th:attr="data-id=${service.msId}">ìƒíƒœí™•ì¸</button>
                    <div class="status-result" th:id="'status-' + ${service.msId}"
                         style="margin-top:4px;font-size:12px;"></div>
                </td>
                <td th:text="${service.msCheckInterval} + 'ì´ˆ'">60ì´ˆ</td>
                <td>
                    <span th:if="${service.msEnabled}" style="color:#22c55e;">âœ“ í™œì„±</span>
                    <span th:unless="${service.msEnabled}" style="color:#94a3b8;">âœ— ë¹„í™œì„±</span>
                </td>
                <td>
                    <span th:if="${service.msAlertEnabled}" style="color:#3b82f6;">âœ“ ON</span>
                    <span th:unless="${service.msAlertEnabled}" style="color:#94a3b8;">âœ— OFF</span>
                </td>
                <td>
                    <a th:href="@{'/mgmt/monitoring/edit/' + ${service.msId}}" class="btn btn_03">ìˆ˜ì •</a>
                    <a th:href="@{'/mgmt/monitoring/history/' + ${service.msId}}" class="btn btn_03">ì´ë ¥</a>
                    <form th:action="@{'/mgmt/monitoring/delete/' + ${service.msId}}" method="post"
                          style="display:inline;" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn btn_02">ì‚­ì œ</button>
                    </form>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(services)}">
                <td colspan="8" class="empty_table">ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <script th:attr="nonce=${cspNonce}">
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCsrfToken() {
            if (typeof window.APP_CSRF_TOKEN === "string") {
                return window.APP_CSRF_TOKEN;
            }
            var metaTag = document.querySelector('meta[name="_csrf"]');
            return metaTag ? metaTag.getAttribute('content') : '';
        }

        document.querySelectorAll('.check-service').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var serviceId = this.getAttribute('data-id');
                var statusDiv = document.getElementById('status-' + serviceId);
                statusDiv.innerHTML = '<span style="color:#3b82f6;">í™•ì¸ì¤‘...</span>';

                var csrfToken = getCsrfToken();
                var headers = {
                    'Content-Type': 'application/json'
                };

                // CSRF í† í°ì´ ìˆìœ¼ë©´ í—¤ë”ì— ì¶”ê°€
                if (csrfToken) {
                    headers['X-CSRF-TOKEN'] = csrfToken;
                }

                fetch('/datahub/board/mgmt/monitoring/check/' + serviceId, {
                    method: 'POST',
                    headers: headers
                })
                .then(response => {
                    // HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error('HTTP ' + response.status + ': ' + text);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    var color = data.healthy ? '#22c55e' : '#ef4444';
                    var status = data.status || 'ERROR';
                    var msg = '<span style="color:' + color + ';">' + status + '</span>';

                    if (data.responseTime) {
                        msg += ' (' + data.responseTime + ')';
                    }
                    if (data.error) {
                        msg += '<br><span style="color:#ef4444;font-size:11px;">' + data.error + '</span>';
                    }

                    statusDiv.innerHTML = msg;
                })
                .catch(error => {
                    var errorMsg = error.message || error.toString();
                    statusDiv.innerHTML = '<span style="color:#ef4444;">ì²´í¬ ì‹¤íŒ¨</span>' +
                        '<br><span style="color:#ef4444;font-size:11px;">' + errorMsg + '</span>';
                    console.error('Error:', error);
                });
            });
        });
    </script>

    <style>
        .empty_table {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .check-service {
            cursor: pointer;
            min-width: 80px;
        }

        .status-result {
            min-height: 20px;
        }
    </style>
</div>
</body>
</html>
