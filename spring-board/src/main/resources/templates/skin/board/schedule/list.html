<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/js/font-awesome/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/css/default.css}">
    <link rel="stylesheet" th:href="@{/css/index.css}">
    <title th:text="${board.boSubject} + ' - 일정'">일정</title>
    <link rel="stylesheet" th:href="@{/skin/board/schedule/wzappend.css}">
    <link rel="stylesheet" th:href="@{/skin/board/schedule/style.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: nav}"></div>
<div id="wrapper">
    <div id="container_wr">
        <div id="container">
            <h1 id="container_title" th:text="${pageTitle} ?: (board != null ? board.boSubject : '게시판')">게시판</h1>

            <script th:src="@{/skin/board/schedule/wz.js/jquery.min.js}"></script>
            <script th:src="@{/skin/board/schedule/wz.js/fullcalendar.js}"></script>
            <script th:src="@{/skin/board/schedule/wz.js/ko.js}"></script>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"></div>
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>

            <div class="calendar-legend" th:if="${board.boUseCategory == 1}">
                <div class="legend-left">
                    <span class="legend-item" data-category="" style="background:#999;"></span> 전체
                    <span th:each="cat : ${#strings.arraySplit(board.boCategoryList, '|')}"
                          class="legend-item"
                          th:attr="data-category=${cat}"
                          th:text="${cat}">분류</span>
                </div>
                <div class="legend-right">
                    <a th:if="${(loginUser != null && loginUser.level >= board.boWriteLevel) || (loginUser == null && board.boWriteLevel <= 1)}"
                       th:href="@{'/bbs/' + ${boTable} + '/write'}" class="btn-add-event">+ 일정 등록하기</a>
                </div>
            </div>

            <script th:inline="javascript">
                document.addEventListener('DOMContentLoaded', function () {
                    if (!window.jQuery || !jQuery.fn.fullCalendar) {
                        return;
                    }
        var boTable = /*[[${boTable}]]*/ '';
        var appBase = /*[[@{/}]]*/ '/';
        appBase = appBase.replace(/\/?$/, '/');
        var categories = /*[[${board.boUseCategory == 1 ? #strings.arraySplit(board.boCategoryList, '|') : null}]]*/ null;
                    var palette = ['#FF6B6B', '#4ECDC4', '#4A90E2', '#A29BFE', '#FEFB9B', '#7C7C7C', '#1d69b5'];
                    var categoryColors = {};
                    if (categories) {
                        categories.forEach(function (cat, idx) {
                            categoryColors[cat] = palette[idx % palette.length];
                        });
                    }
                    var currentCategory = null;

                    function colorFor(cat) {
                        return (cat && categoryColors[cat]) ? categoryColors[cat] : '#3788d8';
                    }

                    var $calendar = jQuery('#calendar');
                    $calendar.fullCalendar({
            locale: 'ko',
            height: 600,
            header: { left: 'prev,next today', center: 'title', right: 'month,agendaWeek,agendaDay' },
            events: appBase + 'bbs/' + boTable + '/events',
            dayClick: function (date) {
                var ymd = date.format('YYYY-MM-DD');
                window.location.href = appBase + 'bbs/' + boTable + '/write?wr_1=' + ymd + '&wr_2=' + ymd + '&allday=1';
            },
                        eventClick: function (event) {
                            if (event.url) {
                                window.location.href = event.url;
                                return false;
                            }
                            return true;
                        },
                        eventRender: function (event, element) {
                            if (currentCategory && event.category !== currentCategory) {
                                return false;
                            }
                            var color = event.color || colorFor(event.category);
                            element.css('background-color', color);
                            element.css('border-color', color);
                            if (event.commentCount && event.commentCount > 0) {
                                element.find('.fc-title').append(' <span class="cnt_cmt">' + event.commentCount + '</span>');
                            }
                            return true;
                        }
                    });

                    var legendItems = document.querySelectorAll('.calendar-legend .legend-item');
                    if (legendItems.length) {
                        legendItems.forEach(function (el) {
                            var cat = el.getAttribute('data-category');
                            if (cat) {
                                el.style.background = colorFor(cat);
                                if (colorFor(cat) === '#FEFB9B') {
                                    el.style.color = '#000';
                                }
                            }
                            el.addEventListener('click', function () {
                                currentCategory = cat || null;
                                $calendar.fullCalendar('refetchEvents');
                            });
                        });
                    }
                });
            </script>

            <form method="get" th:action="@{'/bbs/' + ${boTable} + '/list'}" style="margin: 12px 0;">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="size" th:value="${result.size}" />
                <span th:if="${board.boUseCategory == 1}">
                    <select name="sca">
                        <option value="">전체 분류</option>
                        <option th:each="cat : ${#strings.arraySplit(board.boCategoryList, '|')}"
                                th:value="${cat}"
                                th:selected="${sca == cat}"
                                th:text="${cat}">분류</option>
                    </select>
                </span>
                <select name="sfl">
                    <option value="wr_subject" th:selected="${sfl == 'wr_subject'}">제목</option>
                    <option value="wr_content" th:selected="${sfl == 'wr_content'}">내용</option>
                    <option value="wr_subject||wr_content" th:selected="${sfl == 'wr_subject||wr_content'}">제목+내용</option>
                    <option th:if="${loginUser != null && loginUser.level >= 10}" value="mb_id,1" th:selected="${sfl == 'mb_id,1'}">회원아이디</option>
                    <option th:if="${loginUser != null && loginUser.level >= 10}" value="mb_id,0" th:selected="${sfl == 'mb_id,0'}">회원아이디(코)</option>
                    <option value="wr_name,1" th:selected="${sfl == 'wr_name,1'}">글쓴이</option>
                    <option value="wr_name,0" th:selected="${sfl == 'wr_name,0'}">글쓴이(코)</option>
                </select>
                <input type="text" name="stx" th:value="${stx}" placeholder="검색어" />
                <input type="date" name="sdate" th:value="${sdate}" />
                <input type="date" name="edate" th:value="${edate}" />
                <input type="hidden" name="sop" th:value="${sop}" />
                <button type="submit">검색</button>
            </form>
        </div>
    </div>
</div>
<div th:replace="~{fragments/nav :: nav_end}"></div>
</body>
</html>
